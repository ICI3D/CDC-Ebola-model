---
title: "CDC Meltzer et al. Model Re-implementation"
author: "Carl A. B. Pearson"
date: "2014 NOV 06"
output:
  html_document:
    self_contained: no
    smart: no
runtime: shiny
---
```{r, echo=FALSE}
require(stats)
source("./cdc_model_functions.R")
source("./cdc_plotting_functions.R")
```

### Results

```{r run, echo=FALSE}
res <- reactive({
  simulate(list(
    infective_treatments = defaults$infective_treatments,
    treatment_durations = treatment_durations(),
    simulation_duration = defaults$simulation_duration,
    treatment_distribution = defaults$treatment_distribution,
    introductions = defaults$introductions, 
    treatment_transmissions = treatment_transmissions(),
    hosp_proportions = treatment_demands(),
    E_day_PDF = distros$inc()$pdf,
    I_day_PDF = distros$inf()$pdf,
    N0 = N0()
  ))
})
tabsetPanel(
  tabPanel("Cumulative Incidence", renderPlot({ plotCumInc(res()) })),
  tabPanel("Bed Occupancy", renderPlot({ plotBedOcc(res()) }))
)
```

### Model Settings

```{r disease_params, echo=FALSE}
absolute_pdf_day_max <- 60
manualPDF <- function(prefix) {
  lapply(
    1:absolute_pdf_day_max,
    function(day) conditionalPanel(
      paste0("input.",prefix,"_period_max >= ",day),
      numericInput(paste0(prefix, "_pdf_", day), day, 0, min=0, max=1, step=0.0001)
    )
  )
}
#incubation_entries <- 
buildPDFPanel <- function(prefix, full,
  def_period_max,
  def_model,
  def_period_mean,
  def_period_sd,
  choices
) {
  column(4,
    numericInput(
      paste0(prefix,"_period_max"),
      paste0(full," Period Max (days)?"),
      min=1, max=absolute_pdf_day_max, value=def_period_max, step=1
    ),
    conditionalPanel("input.pdf_type == 'manual'",
      renderText(paste0("Total ",full," Day P: ", sum(distros[[prefix]]()$pdf))),
      renderText(paste0(full," Day")),
      manualPDF(prefix)
    ),
    conditionalPanel("input.pdf_type == 'functional'",
      selectInput(
        paste0(prefix,"_model"),
        paste0(full," Distribution"),
        choices=choices, selected=def_model
      ),
      numericInput(
        paste0(prefix,"_period_mean"),
        paste0(full, " Period Mean (days)?"),
        min=0.01, max=25, value=def_period_mean, step=0.01
      ),
      numericInput(
        paste0(prefix,"_period_sd"),
        paste0(full, " Period St.Dev (days)?"),
        min=0.01, max=25, value=def_period_sd, step=0.01
      )
    )
  )
}
buildTreatmentCol <- function(prefix, defs, step, max, treatments = defaults$infective_treatments) {
  mapply(function(id, label, def) numericInput(id, label, min=0, step=step, max=max, value=def),
    paste0(prefix, names(treatments)),
    treatments,
    defs,
    SIMPLIFY=F
  )
}
with(defaults, {
  tabsetPanel(
    tabPanel("General Parameters", inputPanel(
      numericInput("N0","Initial Population (millions)?", value=N0/10^6, min=0.01, max=100, step=0.01)
    )),
    tabPanel("Incubation and Infectious Distributions", inputPanel(
      actionButton("reset_cdc", "Set to CDC defaults."),
      actionButton("reset_leg", "Set to Legrand."),
      actionButton("reset_eic", "Set to Eichner."),
      radioButtons(
        "pdf_type",
        "Distribution Specification: ",
        choices=c("manual","functional"), selected="manual",
        inline=T
      ),
      fixedRow(
        buildPDFPanel("inc", "Incubation", inc_period_max, inc_model, inc_period_mean, inc_period_sd, choices),
        buildPDFPanel("inf", "Infectious", inf_period_max, inf_model, inf_period_mean, inf_period_sd, choices)
      )
    )),
    tabPanel("Treatment-Related Parameters", inputPanel(
      fixedRow(
        column(3,
          renderText("Infection pressure from..."),
          buildTreatmentCol('tr_rate_', defaults$treatment_transmissions, step=0.01, max=10.0)
        ),
        column(3,
          renderText("Hospital bed-days for..."),
          buildTreatmentCol('tr_dur_', defaults$treatment_durations, step=1, max=absolute_pdf_day_max)
        ),
        column(3,
          renderText("Hospitalized Proportion for..."),
          buildTreatmentCol('tr_prop_', defaults$hosp_proportions, step=0.01, max=1.0)
        )
      )
    ))
  )
})
```

```{r pdfs, echo=FALSE}
buildReactiveDistro <- function(prefix) {
  ref_period_max <- paste0(prefix,"_period_max")
  pdf_base <- paste0(prefix,"_pdf_")
  ref_model <- paste0(prefix,"_model")
  ref_mean <- paste0(prefix,"_period_mean")
  ref_sd <- paste0(prefix,"_period_sd")
  return(
    reactive({
      validate(need(!is.null(input$pdf_type),"PDF type not initialized."))
      max_day <- input[[ref_period_max]]
      validate(need(!is.null(max_day), "max duration not initialized."))
      res <- if (input$pdf_type == "manual") {
        day_labels <- paste0(pdf_base, 1:max_day)
        validate(need(!is.null(input[[tail(day_labels, 1)]]), "Awaiting manual pdf construction."))
        temp <- sapply(day_labels, function(day) input[[day]])
        list(pdf=temp, cdf=c(0,cumsum(temp)), days=0:(length(temp)-1))
      } else {
        model <- input[[ref_model]]
        other_params <- switch(model,
          gamma =,
          lnorm = list(period_mean = input[[ref_mean]], period_sd = input[[ref_sd]]),
          list()
        )
        do.call(distribution, c(list(model=model, period_max=max_day), other_params) )
      }
      validate(need(sum(res$pdf)==1, "PDF does not sum to 1."))
      return(res)
    })
  )
}
distros <- list(inc=buildReactiveDistro("inc"), inf=buildReactiveDistro("inf"))
treatment_parameter <- function(prefix, ...) {
  ref <- paste0(prefix, names(defaults$infective_treatments))
  names(ref) <- names(defaults$infective_treatments)
  return(reactive({
    res <- sapply(ref, function(what) input[[what]])
    validate(need(all(!sapply(res, is.null)), paste0(prefix," info incomplete.")))
    for (test in list(...)) with(test, validate(need(f(res), msg)))
    return(res)
  }))
}
treatment_durations <- treatment_parameter('tr_dur_',
  list(f=function(res) all(res == floor(res)), msg="treatment durations not integers."),
  list(f=function(res) all(res >= 0), msg="treatment durations not positive.")
)
treatment_transmissions <- treatment_parameter('tr_rate_',
  list(f=function(res) all(res >= 0), msg="treatment rates not positive.")
)
treatment_demands <- treatment_parameter('tr_prop_',
  list(f=function(res) all((res >= 0) & (res <= 1)), msg="hospitalization proportions not in [0,1].")
)
N0 <- reactive({ input$N0 * 10^6 })
```

### Model Settings Displays

```{r output_disease_params, echo=FALSE}
renderPlot({
  validate(need(!is.null(input$inf_period_max), "Awaiting initialization of incfection period."))
  plotIncubationCDF(distros$inc(), input$inf_period_max)
})
```

```{r, echo=FALSE}
resetter <- function(infpdf, incpdf, pdf_type="manual") {
  inc_max <- length(incpdf)
  inf_max <- length(infpdf)
  updateNumericInput(session, "inf_period_max", value=inf_max)
  updateNumericInput(session, "inc_period_max", value=inc_max)
  updateRadioButtons(session, "pdf_type", selected=pdf_type)
  mapply(function(label, p) updateNumericInput(session, label, value=p),
         paste0('inc_pdf_',1:inc_max), incpdf)
  mapply(function(label, p) updateNumericInput(session, label, value=p),
       paste0('inf_pdf_',1:inf_max), infpdf)
}
with(defaults,{
  observe({
    input$reset_cdc
    resetter(inf_pdf_ref, inc_pdf_ref$cdc)
  }, priority = 0)
  observe({
    input$reset_leg
    resetter(inf_pdf_ref, inc_pdf_ref$legrand)
  }, priority = 1)
  observe({
    input$reset_eic
    resetter(inf_pdf_ref, inc_pdf_ref$eichner)
  }, priority = 2)
})
```

TODOs:

 - turn on asymptomatic infection
 - turn on mortality (and allow to affect governor)